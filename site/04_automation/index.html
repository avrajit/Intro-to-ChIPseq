



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content=""">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.4, mkdocs-material-2.9.2">
    
    
      
        <title>"Automating QC and Alignment"</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.ba0fd1a6.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.6079476c.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="white" data-md-color-accent="light-green">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#learning-objectives" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Introduction to ChIP-seq" class="md-header-nav__button md-logo">
          
            <img src="../images/dna-sequence-1600x800.jpg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Introduction to ChIP-seq
              </span>
              <span class="md-header-nav__topic">
                Automating generation of alignment files
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../images/dna-sequence-1600x800.jpg" width="48" height="48">
      
    </span>
    Introduction to ChIP-seq
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../schedule/" title="Class schedule" class="md-nav__link">
      Class schedule
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Lessons
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Lessons
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../01_Intro_chipseq_data_organization/" title="Project Organization and Best Practices in Data Management" class="md-nav__link">
      Project Organization and Best Practices in Data Management
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../02_QC_FASTQC/" title="Sequencing data QC using FastQC" class="md-nav__link">
      Sequencing data QC using FastQC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../03_align_and_filtering/" title="Alignment and filtering of reads" class="md-nav__link">
      Alignment and filtering of reads
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Automating generation of alignment files
      </label>
    
    <a href="./" title="Automating generation of alignment files" class="md-nav__link md-nav__link--active">
      Automating generation of alignment files
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automating-the-chip-seq-analysis-path-from-sequence-reads-to-bam-files" title="Automating the ChIP-seq analysis path from sequence reads to BAM files" class="md-nav__link">
    Automating the ChIP-seq analysis path from sequence reads to BAM files
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-flexibility-with-variables" title="More Flexibility with variables" class="md-nav__link">
    More Flexibility with variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keeping-track-of-tool-versions" title="Keeping track of tool versions" class="md-nav__link">
    Keeping track of tool versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-for-future-debugging" title="Preparing for future debugging" class="md-nav__link">
    Preparing for future debugging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-tools" title="Running the tools" class="md-nav__link">
    Running the tools
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#last-addition-to-the-script" title="Last addition to the script" class="md-nav__link">
    Last addition to the script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-and-running-script" title="Saving and running script" class="md-nav__link">
    Saving and running script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submitting-jobs-in-serial-to-the-slurm-scheduler" title="Submitting jobs in serial to the SLURM scheduler" class="md-nav__link">
    Submitting jobs in serial to the SLURM scheduler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submitting-jobs-in-parallel-to-the-slurm-scheduler" title="Submitting jobs in parallel to the SLURM scheduler" class="md-nav__link">
    Submitting jobs in parallel to the SLURM scheduler
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../05_peak_calling_macs/" title="Peak calling with MACS2" class="md-nav__link">
      Peak calling with MACS2
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../06_QC_cross_correlation/" title="Assessing ChIP quality using cross correlation" class="md-nav__link">
      Assessing ChIP quality using cross correlation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../07_QC_quality_metrics/" title="Assessing Peak calls and ChIP quality using ChIPQC" class="md-nav__link">
      Assessing Peak calls and ChIP quality using ChIPQC
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../08_handling-replicates/" title="Handling Replicates with Bedtools or IDR" class="md-nav__link">
      Handling Replicates with Bedtools or IDR
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../09_data_visualization/" title="Visualization and exploration of ChIP-seq data" class="md-nav__link">
      Visualization and exploration of ChIP-seq data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../10_qualitative_assessment_IGV/" title="Qualitative assessment using IGV" class="md-nav__link">
      Qualitative assessment using IGV
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../11_functional_analysis/" title="Functional analysis" class="md-nav__link">
      Functional analysis
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#learning-objectives" title="Learning Objectives" class="md-nav__link">
    Learning Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#automating-the-chip-seq-analysis-path-from-sequence-reads-to-bam-files" title="Automating the ChIP-seq analysis path from sequence reads to BAM files" class="md-nav__link">
    Automating the ChIP-seq analysis path from sequence reads to BAM files
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#more-flexibility-with-variables" title="More Flexibility with variables" class="md-nav__link">
    More Flexibility with variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keeping-track-of-tool-versions" title="Keeping track of tool versions" class="md-nav__link">
    Keeping track of tool versions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#preparing-for-future-debugging" title="Preparing for future debugging" class="md-nav__link">
    Preparing for future debugging
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#running-the-tools" title="Running the tools" class="md-nav__link">
    Running the tools
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#last-addition-to-the-script" title="Last addition to the script" class="md-nav__link">
    Last addition to the script
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#saving-and-running-script" title="Saving and running script" class="md-nav__link">
    Saving and running script
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submitting-jobs-in-serial-to-the-slurm-scheduler" title="Submitting jobs in serial to the SLURM scheduler" class="md-nav__link">
    Submitting jobs in serial to the SLURM scheduler
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submitting-jobs-in-parallel-to-the-slurm-scheduler" title="Submitting jobs in parallel to the SLURM scheduler" class="md-nav__link">
    Submitting jobs in parallel to the SLURM scheduler
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Automating generation of alignment files</h1>
                
                <p>Contributors: Meeta Mistry, Radhika Khetani</p>
<p>Approximate time: 80 minutes</p>
<h2 id="learning-objectives">Learning Objectives</h2>
<ul>
<li>Write a shell script to generate filtered BAM files for all samples</li>
<li>Describe the difference between serial and parallel jobs</li>
</ul>
<h2 id="automating-the-chip-seq-analysis-path-from-sequence-reads-to-bam-files">Automating the ChIP-seq analysis path from sequence reads to BAM files</h2>
<p>Once you have optimized tools and parameters using a single sample (using an interactive session), you can write a script to run the whole or a portion of the workflow on multiple samples in parallel (batch submission with a shell script).</p>
<p>Writing a reusable shell script ensures that every sample is run with the exact same parameters, and helps to keep track of all the tools and their versions. The shell script is like a lab notebook; in the future, you (or your colleagues) can go back and check the workflow for methods and versions, which goes a long way to making your work more efficient and reproducible.</p>
<p>Before we start with the script, let's check how many cores our interactive session has by using <code>sacct</code>. </p>
<pre><code class="bash">$ sacct
</code></pre>

<p>We need to have an interactive session with 6 cores, if you already have one you are set. If you have a session with fewer cores then <code>exit</code> out of your current interactive session and start a new one with <code>-n 6</code>.</p>
<pre><code class="bash">$ srun --pty -p short -t 0-12:00 -n 6 --mem 8G --reservation=HBC /bin/bash
</code></pre>

<h3 id="more-flexibility-with-variables">More Flexibility with variables</h3>
<p>We can write a shell script that will run on a specific file, but to make it more flexible and efficient we would prefer that it lets us give it an input fastq file when we run the script. To be able to provide an input to any shell script, we need to use <strong>Positional Parameters</strong>.</p>
<p>For example, we can refer to the components of the following command as numbered variables <strong>within</strong> the actual script:</p>
<pre><code class="bash"># * DO NOT RUN *
sh  run_analysis.sh  input.fastq  input.gtf  12
</code></pre>

<p><code>$0</code> =&gt; run_analysis.sh</p>
<p><code>$1</code> =&gt; input.fastq</p>
<p><code>$2</code> =&gt; input.gtf</p>
<p><code>$3</code> =&gt; 12</p>
<p>The variables $1, $2, $3,...$9 and so on are <strong>positional parameters</strong> in the context of the shell script, and can be used within the script to refer to the files/number specified on the command line. Basically, the script is written with the expectation that $1 will be a fastq file and $2 will be a GTF file, and so on.</p>
<p><em>There can be virtually unlimited numbers of inputs to a shell script, but it is wise to only have a few inputs to avoid errors and confusion when running a script that used positional parameters.</em></p>
<blockquote>
<p><a href="http://steve-parker.org/sh/eg/var3.sh.txt">This is an example of a simple script that used the concept of positional parameters and the associated variables</a>. You should try this script out after the class to get a better handle on positional parameters for shell scripting.</p>
</blockquote>
<p>Let's use this new concept in the script we are writing. We want the first positional parameter ($1) to be the name of our fastq file. We could just use the variable <code>$1</code> throughout the script to refer to the fastq file, but this variable name is not intuitive, so we want to create a new variable called <code>fq</code> and copy the contents of <code>$1</code> into it.</p>
<p>First, we need to start a new script called <code>chipseq_analysis_on_input_file.sh</code> in the <code>~/chipseq/scripts/</code> directory:</p>
<pre><code class="bash">$ cd ~/chipseq/scripts/

$ vim chipseq_analysis_on_input_file.sh
</code></pre>

<pre><code class="bash">#!/bin/bash/

# initialize a variable with an intuitive name to store the name of the input fastq file
fq=$1
</code></pre>

<blockquote>
<p>When we set up variables we do not use the <code>$</code> before it, but when we <em>use the variable</em>, we always have to have the <code>$</code> before it. &gt;</p>
<p>For example: </p>
<p>initializing the <code>fq</code> variable =&gt; <code>fq=$1</code></p>
<p>using the <code>fq</code> variable =&gt; <code>fastqc $fq</code></p>
</blockquote>
<p>To ensure that all the output files from the workflow are properly named with sample IDs we should extract the "base name" (or sample ID) from the name of the input file.</p>
<pre><code># grab base of filename for naming outputs
base=`basename $fq _chr12.fastq`
echo &quot;Sample name is $base&quot;           
</code></pre>

<blockquote>
<p><strong>Remember <code>basename</code>?</strong></p>
<ol>
<li>the <code>basename</code> command: this command takes a path or a name and trims away all the information before the last <code>\</code> and if you specify the string to clear away at the end, it will do that as well. In this case, if the variable <code>$fq</code> contains the path <em>"~/chipseq/raw_data/H1hesc_Nanog_Rep1_chr12.fastq"</em>, <code>basename $fq _chr12.fastq</code> will output "H1hesc_Nanog_Rep1".</li>
<li>to assign the value of the <code>basename</code> command to the <code>base</code> variable, we encapsulate the <code>basename...</code> command in backticks. This syntax is necessary for assigning the output of a command to a variable.</li>
</ol>
</blockquote>
<p>Next we want to specify how many cores the script should use to run the analysis. This provides us with an easy way to modify the script to run with more or fewer cores without have to replace the number within all commands where cores are specified.</p>
<pre><code># directory with bowtie genome index
genome=~/chipseq/reference_data/chr12
</code></pre>

<p>We'll create output directories, but with the <code>-p</code> option. This will make sure that <code>mkdir</code> will create the directory only if it does not exist, and it won't throw an error if it does exist.</p>
<pre><code># make all of the output directories
# The -p option means mkdir will create the whole path if it 
# does not exist and refrain from complaining if it does exist
mkdir -p ~/chipseq/results/fastqc
mkdir -p ~/chipseq/results/bowtie2/intermediate_bams
</code></pre>

<p>Now that we have already created our output directories, we can now specify variables with the path to those directories both for convenience but also to make it easier to see what is going on in a long command.</p>
<pre><code># set up output filenames and locations
fastqc_out=~/chipseq/results/fastqc/

## set up file names
align_out=~/chipseq/results/bowtie2/${base}_unsorted.sam
align_bam=~/chipseq/results/bowtie2/${base}_unsorted.bam
align_sorted=~/chipseq/results/bowtie2/${base}_sorted.bam
align_filtered=~/chipseq/results/bowtie2/${base}_aln.bam

## set up more variables for 2 additional directoties to help clean up the results folder
bowtie_results=~/chipseq/results/bowtie2
intermediate_bams=~/chipseq/results/bowtie2/intermediate_bams
</code></pre>

<h3 id="keeping-track-of-tool-versions">Keeping track of tool versions</h3>
<p>All of our variables are now staged. Next, let's make sure all the modules are loaded. This is also a good way to keep track of the versions of tools that you are using in the script:</p>
<pre><code># set up the software environment
module load fastqc/0.11.3
module load gcc/6.2.0  
module load bowtie2/2.2.9
module load samtools/1.3.1
export PATH=/n/app/bcbio/tools/bin:$PATH    # for using 'sambamba'
</code></pre>

<h3 id="preparing-for-future-debugging">Preparing for future debugging</h3>
<p>In the script, it is a good idea to use <code>echo</code> for debugging. <code>echo</code> basically displays the string of characters specified within the quotations. When you have strategically place <code>echo</code> commands specifying what stage of the analysis is next, in case of failure you can determine the last <code>echo</code> statement displayed to troubleshoot the script.</p>
<pre><code>echo &quot;Processing file $fq&quot;
</code></pre>

<blockquote>
<p>You can also use <code>set -x</code>:</p>
<p><code>set -x</code> is a debugging tool that will make bash display the command before executing it. In case of an issue with the commands in the shell script, this type of debugging lets you quickly pinpoint the step that is throwing an error. Often, tools will display the error that caused the program to stop running, so keep this in mind for times when you are running into issues where this is not available.
You can turn this functionality off by saying <code>set +x</code></p>
</blockquote>
<h3 id="running-the-tools">Running the tools</h3>
<p>Let's write up the commands to run the tools we have already tested, with a couple of modifications:
<em> use variable names instead of actual file names
</em> multithread when possible (<code>bowtie2</code>, <code>sambamba</code>)</p>
<pre><code># Run FastQC
fastqc $fq

# Run bowtie2
bowtie2 -p 6 -q --local -x $genome -U $fq -S $align_out

# Create BAM from SAM
samtools view -h -S -b -@ 6 -o $align_bam $align_out

# Sort BAM file by genomic coordinates
sambamba sort -t 6 -o $align_sorted $align_bam

# Filter out duplicates
sambamba view -h -t 6 -f bam -F &quot;[XS] == null and not unmapped &quot; $align_sorted &gt; $align_filtered

# Move intermediate files out of the bowtie2 directory
mv $bowtie_results/${base}*sorted* $intermediate_bams
</code></pre>

<h3 id="last-addition-to-the-script">Last addition to the script</h3>
<p>It is best practice to have the script <strong>usage</strong> specified at the top any script. This should have information such that when your future self, or a co-worker, uses the script they know what it will do and what input(s) are needed. For our script, we should have the following lines of comments right at the top after <code>#!/bin/bash/</code>:</p>
<pre><code># This script takes a fastq file of ChIP-Seq data, runs FastQC and outputs a BAM file for it that is ready for peak calling. Bowtie2 is the aligner used, and the outputted BAM file is sorted by genomic coordinates and has duplicate reads removed using sambamba.
# USAGE: sh chipseq_analysis_on_input_file.sh &lt;path to the fastq file&gt;
</code></pre>

<p>It is okay to specify this after everything else is set up, since you will have most clarity about the script only once it is fully done.</p>
<p>Your script should now look like this:</p>
<pre><code>#!/bin/bash/

# This script takes a fastq file of ChIP-Seq data, runs FastQC and outputs a BAM file for it that is ready for peak calling. Bowtie2 is the aligner used, and the outputted BAM file is sorted by genomic coordinates and has duplicate reads removed using sambamba.
# USAGE: sh chipseq_analysis_on_input_file.sh &lt;path to the fastq file&gt;

# initialize a variable with an intuitive name to store the name of the input fastq file
fq=$1

# grab base of filename for naming outputs
base=`basename $fq .fastq`
echo &quot;Sample name is $base&quot;    

# directory with bowtie genome index
genome=~/chipseq/reference_data/chr12

# make all of the output directories
# The -p option means mkdir will create the whole path if it 
# does not exist and refrain from complaining if it does exist
mkdir -p ~/chipseq/results/fastqc
mkdir -p ~/chipseq/results/bowtie2/intermediate_bams

# set up output filenames and locations
fastqc_out=~/chipseq/results/fastqc/

## set up file names
align_out=~/chipseq/results/bowtie2/${base}_unsorted.sam
align_bam=~/chipseq/results/bowtie2/${base}_unsorted.bam
align_sorted=~/chipseq/results/bowtie2/${base}_sorted.bam
align_filtered=~/chipseq/results/bowtie2/${base}_aln.bam

## set up more variables for 2 additional directoties to help clean up the results folder
bowtie_results=~/chipseq/results/bowtie2
intermediate_bams=~/chipseq/results/bowtie2/intermediate_bams

# set up the software environment
module load fastqc/0.11.3
module load gcc/6.2.0  
module load bowtie2/2.2.9
module load samtools/1.3.1
export PATH=/n/app/bcbio/tools/bin:$PATH    # for using 'sambamba'

echo &quot;Processing file $fq&quot;

# Run FastQC and move output to the appropriate folder
fastqc $fq
mv *_fastqc.* ~/chipseq/results/fastqc/

# Run bowtie2
bowtie2 -p 6 -q --local -x $genome -U $fq -S $align_out

# Create BAM from SAM
samtools view -h -S -b -@ 6 -o $align_bam $align_out

# Sort BAM file by genomic coordinates
sambamba sort -t 6 -o $align_sorted $align_bam

# Filter out duplicates
sambamba view -h -t 6 -f bam -F &quot;[XS] == null and not unmapped &quot; $align_sorted &gt; $align_filtered

# Move intermediate files out of the bowtie2 directory
mv $bowtie_results/${base}*sorted* $intermediate_bams
</code></pre>

<h3 id="saving-and-running-script">Saving and running script</h3>
<p>We should all have an interactive session with 6 cores, so we can run the script as follows:</p>
<pre><code class="bash">$ sh chipseq_analysis_on_input_file.sh ~/chipseq/raw_data/H1hesc_Nanog_Rep1_chr12.fastq
</code></pre>

<h2 id="submitting-jobs-in-serial-to-the-slurm-scheduler">Submitting jobs <strong>in serial</strong> to the SLURM scheduler</h2>
<p>The above script will run in an interactive session <strong>one file at a time</strong>. But the whole point of writing this script was to run it on all files at once. How do you think we can do this?</p>
<p>To run the above script <strong>"in serial"</strong> for all of the files on a worker node via the job scheduler, we can create a separate submission script that will need 2 components:</p>
<ol>
<li><strong>SLURM directives</strong> at the <strong>beginning</strong> of the script. This is so that the scheduler knows what resources we need in order to run our job on the compute node(s).</li>
<li>a <strong><code>for</code></strong> loop that iterates through and runs the above script for all the fastq files.</li>
</ol>
<p>Below is what this second script (<code>chipseq_analysis_on_allfiles.slurm</code>) would look like <strong>[DO NOT RUN THIS]</strong>:</p>
<pre><code># **\[DO NOT RUN THIS\]**

#!/bin/bash

#SBATCH -p short        # partition name
#SBATCH -t 0-2:00       # hours:minutes runlimit after which job will be killed
#SBATCH -n 6        # number of cores requested -- this needs to be greater than or equal to the number of cores you plan to use to run your job
#SBATCH --job-name Nanog_Rep1       # Job name
#SBATCH -o %j.out           # File to which standard out will be written
#SBATCH -e %j.err       # File to which standard error will be written

# this `for` loop, will take chip-seq fastq files as input and output filtered BAM files ready for peak calling.

for fq in ~/chipseq/raw_data/*.fastq
do
  echo &quot;running analysis on $fq&quot;
  sh chipseq_analysis_on_input_file.sh $fq
done
</code></pre>

<p><strong>But we don't want to run the analysis on these 6 samples one after the other!</strong> We want to run them "in parallel" as 6 separate jobs. </p>
<blockquote>
<p><strong>Note:</strong> If you create and run the above script, or something similar to it, i.e. with SLURM directives at the top, you should give the script name <code>.run</code> or <code>.slurm</code> as the extension. This will make it obvious that it is meant to submit jobs to the SLURM scheduler. </p>
</blockquote>
<p>To the run the above script you would have used the following command: <code>sbatch chipseq_analysis_on_allfiles.slurm</code>.  </p>
<h2 id="submitting-jobs-in-parallel-to-the-slurm-scheduler">Submitting jobs <strong>in parallel</strong> to the SLURM scheduler</h2>
<p>Parallelization will save you a lot of time with real (large) datasets. To parallelize our analysis, we will still need to write a second script that will call the original script we just wrote. We will still use a <code>for</code> loop, but we will be creating a regular shell script and we will be specifying the SLURM directives a little differently. </p>
<p>Use <code>vim</code> to start a new shell script called <code>chipseq_analysis_on_allfiles-for_slurm.sh</code>: </p>
<pre><code class="bash">$ vim chipseq_analysis_on_allfiles_for-slurm.sh
</code></pre>

<p>This script loops through the same files as in the previous (demo) script, but the command being submitted within the <code>for</code> loop is <code>sbatch</code> with SLURM directives specified on the same line:</p>
<pre><code class="bash">#! /bin/bash

for fq in ~/chipseq/raw_data/*.fastq
do

sbatch -p short -t 0-2:00 -n 6 --job-name chipseq-analysis --wrap=&quot;sh ~/chipseq/scripts/chipseq_analysis_on_input_file.sh $fq&quot;
sleep 1     # wait 1 second between each job submission

done
</code></pre>

<blockquote>
<p>Please note that after the <code>sbatch</code> directives the command <code>sh ~/chipseq/scripts/chipseq_analysis_on_input_file.sh $fq</code> is in quotes.</p>
</blockquote>
<p>What you should see on the output of your screen would be the jobIDs that are returned from the scheduler for each of the jobs that your script submitted.</p>
<p>You can use <code>sacct login_ID</code> to check progress.</p>
<p>Don't forget about the <code>scancel</code> command, should something go wrong and you need to cancel your jobs.</p>
<blockquote>
<p><strong>NOTE:</strong> All job schedulers are similar, but not the same. Once you understand how one works, you can transition to another one without too much trouble. They all have their pros and cons which are considered by the system administrators when picking one for a given HPC environment. </p>
</blockquote>
<hr />
<p><em>This lesson has been developed by members of the teaching team at the <a href="http://bioinformatics.sph.harvard.edu/">Harvard Chan Bioinformatics Core (HBC)</a>. These are open access materials distributed under the terms of the <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution license</a> (CC BY 4.0), which permits unrestricted use, distribution, and reproduction in any medium, provided the original author and source are credited.</em></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../03_align_and_filtering/" title="Alignment and filtering of reads" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Alignment and filtering of reads
              </span>
            </div>
          </a>
        
        
          <a href="../05_peak_calling_macs/" title="Peak calling with MACS2" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Peak calling with MACS2
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.a59e2a89.js"></script>
      
      <script>app.initialize({version:"0.17.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>